<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mapa con conexiones</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      background: #222;
      color: white;
      font-family: sans-serif;
      text-align: center;
    }
    .controls {
      margin: 20px 0;
    }
    input, button {
      padding: 8px 12px;
      margin: 5px;
      border: none;
      border-radius: 8px;
    }
    .mapa-container {
      position: relative;
      width: 100%;
      height: 600px;
    }
    .mapa {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 80px;
      padding: 20px;
      position: relative;
      z-index: 1;
    }
    .piso {
      display: flex;
      flex-direction: column;
      gap: 40px;
      align-items: center;
      position: relative;
    }
    .nodo {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      cursor: pointer;
      border: 2px solid white;
      position: relative;
    }
    .M { background: red; }
    .T { background: yellow; color: black; }
    .E { background: purple; }
    .F { background: orange; }
    .Final { background: black; color: white; border: 2px solid gold; }
    svg {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 0;
      width: 100%;
      height: 100%;
    }
    pre {
      text-align: left;
      background: #111;
      padding: 10px;
      border-radius: 8px;
      max-height: 300px;
      overflow: auto;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>Mapa estilo Slay the Spire</h1>

  <div class="controls">
    <input id="input" type="number" placeholder="cantidad de pisos">
    <button id="boton">Generar Mapa</button>
    <button id="guardar">Guardar</button>
  </div>

  <div class="mapa-container">
    <svg id="conexiones"></svg>
    <div id="mapa" class="mapa"></div>
  </div>

  <pre id="salida"></pre>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.8.1/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/JZylber/SoqueTIC-Client@v1.4.1/soquetic-client.js"></script>

  <script>
    connect2Server();

    const boton = document.getElementById("boton");
    const input = document.getElementById("input");
    const salida = document.getElementById("salida");
    const guardar = document.getElementById("guardar");

    function renderMapa(data) {
      const container = document.getElementById("mapa");
      const svg = document.getElementById("conexiones");
      container.innerHTML = "";
      svg.innerHTML = "";

      const posiciones = {};

      data.grafo.forEach((piso) => {
        const col = document.createElement("div");
        col.className = "piso";

        piso.forEach((nodo) => {
          const div = document.createElement("div");
          if (typeof nodo === "string") {
            div.className = "nodo Final";
            div.textContent = "B";
            posiciones["Final Boss"] = {};
          } else {
            const tipo = nodo.id.split("-")[2];
            div.className = `nodo ${tipo}`;
            div.textContent = tipo;
          }

          col.appendChild(div);

          setTimeout(() => {
            const rect = div.getBoundingClientRect();
            const parentRect = container.getBoundingClientRect();
            posiciones[typeof nodo === "string" ? nodo : nodo.id] = {
              x: rect.left + rect.width / 2 - parentRect.left,
              y: rect.top + rect.height / 2 - parentRect.top
            };
          }, 0);
        });

        container.appendChild(col);
      });

      setTimeout(() => {
        data.conexiones.forEach(([origen, destino]) => {
          const idOrigen = origen.id;
          const idDestino = destino.id;
          if (posiciones[idOrigen] && posiciones[idDestino]) {
            const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
            line.setAttribute("x1", posiciones[idOrigen].x);
            line.setAttribute("y1", posiciones[idOrigen].y);
            line.setAttribute("x2", posiciones[idDestino].x);
            line.setAttribute("y2", posiciones[idDestino].y);
            line.setAttribute("stroke", "white");
            svg.appendChild(line);
          }
        });
      }, 100);
    }

    boton.addEventListener("click", () => {
      const pisos = parseInt(input.value);
      if (pisos <= 0) {
        alert("La cantidad de pisos no puede ser menor o igual a 0");
        return;
      }

      getEvent(`mapa?cantidadpisos=${pisos}`, (data) => {
        console.log("Mapa generado:", data);
        salida.innerText = JSON.stringify(data, null, 2);
        renderMapa(data); // <--- ACTUALIZA EL MAPA EN PANTALLA
      });
    });

    guardar.addEventListener("click", () => {
      postEvent("guardar", true);
    });
  </script>
</body>
</html>
